#### 一、前言

一般来说，系统如果出现卡顿，响应漫长，多半是因为sql语句存在慢查询问题，针对慢查询的问题，解决的性价比也是非常高的，只要针对慢查询sql进行合理的优化，系统的性能就能提升很多。本文就针对慢查询问题提几点优化方式。

#### 二、慢查询的系统表现

首先如果判别系统是否有Sql慢查询的问题呢？我想可以从下面3个方面入手分析：

1. 看看数据库服务器cpu的负载高不高，高的话，应该是sql中从在比较大的计算量。

2. 看看IO返回慢不慢，卡不卡，卡的话可能进行的全表扫描。

3. 查询语句正常，单查询还是慢，看看是否存在索引失效的情况。


#### 三、开启慢查询日志

如果你用的不是阿里云这种RDS产品，那么你需要手工去检查一下mysql的慢查询日志是否开启。

MySQL 的配置文件 my.cnf 

```properties
slow_query_log = 1
slow_query_log_file = /var/log/mysql/log-slow-queries.log
long_query_time = 2
```

在实际项目中，由于生成的慢查询日志比较大，分析起来不是很方便，因此MySql官方提供了mysqdumpslow这个工具。

#### 四、SQL调优

在进行慢查询分析时，我们拿到慢查询语句，可以用explain 进行分析，而不是直接去把慢查询sql执行一遍。

索引的使用有几个比较重要的原则（推荐美团点评技术团队的几点总结）：

1. ##### 最左前缀匹配原则

   mysql 会一直向右匹配直到遇到`>,<,between,like`就停止匹配，比如 :

   ```
   a = 1 and b = 2 and c > 3 and d = 4 如果建立(a,b,c,d)顺序的索引，d是用不到索引的，如果建立(a,b,d,c)的索引则都可以用到，a,b,d的顺序可以任意调整；

   =和in可以乱序，比如a = 1 and b = 2 and c = 3 建立(a,b,c)索引可以任意顺序，mysql的查询优化器会帮你优化成索引可以识别的形式；
   ```

2. ##### 尽量选择区分度高的列作为索引

   区分度的公式是`count(distinct col)/count(*)`，表示字段不重复的比例，比例越大我们扫描的记录数越少，唯一键的区分度是1，而一些状态、性别字段可能在大数据面前区分度就是0，那可能有人会问，这个比例有什么经验值吗？使用场景不同，这个值也很难确定，**一般需要join的字段我们都要求是0.1以上**，即平均1条扫描10条记录；

3. ##### 索引列不能参与计算，保持列“干净”

   ```
   比如:
   from_unixtime(create_time) = ’2014-05-29’就不能使用到索引，原因很简单，b+树中存的都是数据表中的字段值，但进行检索时，需要把所有元素都应用函数才能比较，显然成本太大。所以语句应该写成create_time = unix_timestamp(’2014-05-29’);
   ```

4. ##### 尽量的扩展索引，不要新建索引。

   比如表中已经有a的索引，现在要加(a,b)的索引，那么只需要修改原来的索引即可。

#### 五、总结

基于本文的思路，关于慢查询的问题，可以按一下步骤排除：

1. 打开mysql的慢查询日志，分析慢查询sql，看是否存在占用过多资源的sql，如果存在，在不影响业务的情况下，对sql语句进行优化，像进or转in等。
2. 考虑调整mysql的系统参数：innodb_buffer_pool_size,innodb_log_file_size,table_cache
3. 确定是否是因高并发引起的所等待时间过长
4. 如果数据量实在过大，则要考虑分库分表



本文参考https://www.toutiao.com/i6480081241449169421/

